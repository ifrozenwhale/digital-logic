[toc]

# 密码锁设计

## 目标

设计一个密码锁电路，可以通过拨码开关设置初始密码，通过按钮来输入密码，密码位数至少为4位，判断输入密码与设置的密码是否一致。

> 两种方案，分别采用状态机和模块化的方式实现。

## 方案一

### 功能

1. 实现四位长度密码。
2. 修改密码需要身份验证，输入原密码和新密码，校验成功则设置新密码成功。
3. 开锁有最大尝试次数，超过最大次数则密码锁自锁。
4. 操作的各种结果提示信号将持续时间T，操作成功时间T后如果没有行动会自动返回初始状态。

### IO

#### 数据读入

使用10个拨码开关来做一个数字，（0-9），密码长度为4位（4位0-9的数字）

- 按键load来读入这10个数
- 按键change来设置密码
- 按键open来打开锁
- 按键sure来确认操作
- 拨码开关rst_in来重置输入的数字
- 拨码开关rst_code来重置密码
- 拨码开关rst_open来重置信号灯的显示
- 拨码开关rst_smg来重置数码管显示
- 拨码开关rst_timer来重置计时器
- 拨码开关rst来重置状态

#### 数据读出

- 使用4个七段数码管显示输入的4位数字（0-9）
- 使用LED灯指示剩余可尝试的次数
- 使用LED灯代表密码锁自锁
- 使用LED灯代表修改密码成功
- 使用两个LED灯分别代表succ或者fail
- 使用两个LED灯分别代表当前正处于开锁或修改密码过程

### 模块解释

#### **1. 计数器**

- 用于读入数据，一共有8个临时存储
- 在开锁时，默认使用前四位。
- 在修改密码时，前四个用于保存身份验证时输入的原密码，后四个表示要设置的新密码
- 每次load加载进一个数字（0-9），计数器加一，直到4位（或者8位）

#### **2.** **状态机**

- 状态机共有6个状态，分别为初始状态，开锁状态，修改密码状态，开锁成功状态，自锁状态，密码成功修改状态
- 一开始为初始状态，当判定action行为为开锁时，跳转到开锁状态，当判定action行为为修改密码时，跳转到修改密码状态
- 在开锁状态，如果开锁的结果为成功，则跳转到成功开锁状态，如果结果为失败，则停留在此状态，如果达到操作次数上限，则跳转到自锁状态
- 在修改密码状态，如果身份验证的结果为成功，则跳转到成功修改密码状态，如果为失败，则停留在此状态
- 在开锁成功状态、修改密码成功状态和自锁状态，持续时间T后自动跳转到初始状态
- rst用于状态复位，直接回到初始状态。

#### **3.** **状态输出**

- 不同的状态对应不同的信号输出
- 指示当前操作阶段的信号：change_now表示正在修改密码，open_now 表示正在开锁
- 指示操作结果的信号：succ表示成功开锁，fail表示开锁失败，locked表示自锁，change_succ表示修改密码成功
- 信号的持续时间和状态的持续时间一致，为时间T

#### 4. **激励**

- 生成action行为激励
- 修改密码和开锁不能同时进行
- 开锁对应action 01
- 修改密码对应action 10 

## 方案二

![image-20210316224042563](https://frozenwhale.oss-cn-beijing.aliyuncs.com/img/image-20210316224042563.png)

### 子模块

#### debounce

- 按键消抖

#### smg

- 数码管显示

#### decode

- 10-4编码器，将10_0000_0000编码为0001，代表1，以此类推编码1234567890

#### compare

- 等值比较器
- 给定两个值，输出succ和fail的值

#### lock

- 目前仅仅支持设置密码，开锁，正确就亮正确的灯，不正确就亮不正确的
- 除了消抖没有使用时钟
- 使用按键来模拟时序
- 操作模式为：输入数据，load加载，输完4位，按change表示设置密码，按open表示开锁验证。